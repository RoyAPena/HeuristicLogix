@page "/inventory/categories"
@using HeuristicLogix.Shared.Models
@using HeuristicLogix.Shared.DTOs
@using HeuristicLogix.Shared.Services
@using HeuristicLogix.Client.Features.Inventory.Dialogs
@using FluentValidation
@using Severity = MudBlazor.Severity
@inject HttpClient Http
@inject IValidator<CategoryUpsertDto> CategoryValidator
@inject IDialogService DialogService
@inject ISnackbar Snackbar

<PageTitle>Categorías - Mantenimiento</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-4">
    <MudCard Elevation="0">
        <MudCardHeader>
            <CardHeaderContent>
                <MudText Typo="Typo.h6">
                    <MudIcon Icon="@Icons.Material.Filled.Category" Class="mr-2" />
                    Mantenimiento de Categorías
                </MudText>
            </CardHeaderContent>
            <CardHeaderActions>
                <MudButton Variant="Variant.Filled" 
                           Color="Color.Secondary"
                           StartIcon="@Icons.Material.Filled.Add"
                           OnClick="OpenCreateDialog">
                    Nueva Categoría
                </MudButton>
            </CardHeaderActions>
        </MudCardHeader>
        <MudCardContent>
            @if (IsLoading)
            {
                <MudProgressLinear Color="Color.Primary" Indeterminate="true" Class="my-4" />
            }
            else if (Items == null || !Items.Any())
            {
                <MudAlert Severity="Severity.Info" Class="mt-4">
                    No hay categorías registradas.
                </MudAlert>
            }
            else
            {
                <MudTable Items="@Items" 
                          Hover="true" 
                          Striped="true"
                          Dense="true"
                          FixedHeader="true"
                          Elevation="0"
                          Class="mt-4">
                    <HeaderContent>
                        <MudTh>ID</MudTh>
                        <MudTh>Nombre de Categoría</MudTh>
                        <MudTh Style="text-align: right">Acciones</MudTh>
                    </HeaderContent>
                    <RowTemplate>
                        <MudTd DataLabel="ID" Class="data-id">@context.CategoryId</MudTd>
                        <MudTd DataLabel="Nombre">@context.CategoryName</MudTd>
                        <MudTd DataLabel="Acciones" Style="text-align: right">
                            <MudIconButton Icon="@Icons.Material.Filled.Edit" 
                                           Color="Color.Primary"
                                           Size="Size.Small"
                                           OnClick="@(() => OpenEditDialog(context))" />
                            <MudIconButton Icon="@Icons.Material.Filled.Delete" 
                                           Color="Color.Error"
                                           Size="Size.Small"
                                           OnClick="@(() => DeleteItem(context))" />
                        </MudTd>
                    </RowTemplate>
                </MudTable>
            }
        </MudCardContent>
    </MudCard>
</MudContainer>

@code {
    private IBaseMaintenanceService<Category, CategoryUpsertDto, int> _service = null!;
    private List<Category> Items { get; set; } = new();
    private bool IsLoading { get; set; } = true;

    protected override async Task OnInitializedAsync()
    {
        Console.WriteLine("[CategoryPage] Initializing service...");
        Console.WriteLine($"[CategoryPage] HttpClient BaseAddress: {Http.BaseAddress}");
        _service = new BaseHttpMaintenanceService<Category, CategoryUpsertDto, int>(
            Http, 
            "categories", 
            "Category");
        Console.WriteLine("[CategoryPage] Service initialized successfully");
        await LoadItems();
    }

    private async Task LoadItems()
    {
        IsLoading = true;
        try
        {
            Items = (await _service.GetAllAsync()).ToList();
            Console.WriteLine($"[CategoryPage] Loaded {Items.Count} items");
        }
        catch (Exception ex)
        {
            Console.WriteLine($"[CategoryPage] Error loading items: {ex.Message}");
            Snackbar.Add($"Error: {ex.Message}", Severity.Error);
        }
        finally
        {
            IsLoading = false;
        }
    }

    private async Task OpenCreateDialog()
    {
        Console.WriteLine("[CategoryPage] OpenCreateDialog called");
        
        IDialogReference? dialogRef = null;
        
        var parameters = new DialogParameters
        {
            ["CategoryName"] = string.Empty,
            ["CategoryId"] = 0,
            ["IsEditing"] = false,
            ["OnSubmitCallback"] = EventCallback.Factory.Create<CategoryUpsertDto?>(this, async (dto) =>
            {
                Console.WriteLine($"[CategoryPage] OnSubmitCallback called with DTO: {System.Text.Json.JsonSerializer.Serialize(dto)}");
                if (dto != null)
                {
                    await CreateItem(dto);
                    dialogRef?.Close();
                }
            }),
            ["OnCancelCallback"] = EventCallback.Factory.Create(this, () =>
            {
                Console.WriteLine("[CategoryPage] OnCancelCallback called");
                dialogRef?.Close();
            })
        };

        var options = new DialogOptions 
        { 
            MaxWidth = MaxWidth.Small, 
            FullWidth = true,
            CloseButton = true,
            CloseOnEscapeKey = true
        };

        dialogRef = DialogService.Show<CategoryDialog>("Nueva Categoría", parameters, options);
        await dialogRef.Result;
    }

    private async Task OpenEditDialog(Category category)
    {
        Console.WriteLine($"[CategoryPage] OpenEditDialog called for ID={category.CategoryId}");
        
        IDialogReference? dialogRef = null;
        
        var parameters = new DialogParameters
        {
            ["CategoryName"] = category.CategoryName,
            ["CategoryId"] = category.CategoryId,
            ["IsEditing"] = true,
            ["OnSubmitCallback"] = EventCallback.Factory.Create<CategoryUpsertDto?>(this, async (dto) =>
            {
                Console.WriteLine($"[CategoryPage] OnSubmitCallback called with DTO: {System.Text.Json.JsonSerializer.Serialize(dto)}");
                if (dto != null)
                {
                    await UpdateItem(category.CategoryId, dto);
                    dialogRef?.Close();
                }
            }),
            ["OnCancelCallback"] = EventCallback.Factory.Create(this, () =>
            {
                Console.WriteLine("[CategoryPage] OnCancelCallback called");
                dialogRef?.Close();
            })
        };

        var options = new DialogOptions 
        { 
            MaxWidth = MaxWidth.Small, 
            FullWidth = true,
            CloseButton = true,
            CloseOnEscapeKey = true
        };

        dialogRef = DialogService.Show<CategoryDialog>("Editar Categoría", parameters, options);
        await dialogRef.Result;
    }

    private async Task CreateItem(CategoryUpsertDto dto)
    {
        try
        {
            Console.WriteLine($"[CategoryPage] Creating category: {dto.CategoryName}");
            await _service.CreateAsync(dto);
            Snackbar.Add("Categoría creada exitosamente", Severity.Success);
            await LoadItems();
        }
        catch (HttpRequestException ex)
        {
            Console.WriteLine($"[CategoryPage] Create error: {ex.Message}");
            Snackbar.Add($"Error: {ex.Message}", Severity.Error);
        }
    }

    private async Task UpdateItem(int id, CategoryUpsertDto dto)
    {
        try
        {
            Console.WriteLine($"[CategoryPage] Updating category ID={id}: {dto.CategoryName}");
            await _service.UpdateAsync(id, dto);
            Snackbar.Add("Categoría actualizada exitosamente", Severity.Success);
            await LoadItems();
        }
        catch (HttpRequestException ex)
        {
            Console.WriteLine($"[CategoryPage] Update error: {ex.Message}");
            Snackbar.Add($"Error: {ex.Message}", Severity.Error);
        }
    }

    private async Task DeleteItem(Category category)
    {
        var result = await DialogService.ShowMessageBox(
            "Confirmar Eliminación",
            $"¿Eliminar '{category.CategoryName}'?",
            yesText: "Eliminar", 
            cancelText: "Cancelar");

        if (result == true)
        {
            try
            {
                Console.WriteLine($"[CategoryPage] Deleting category ID={category.CategoryId}");
                await _service.DeleteAsync(category.CategoryId);
                Snackbar.Add("Categoría eliminada exitosamente", Severity.Success);
                await LoadItems();
            }
            catch (HttpRequestException ex)
            {
                Console.WriteLine($"[CategoryPage] Delete error: {ex.Message}");
                Snackbar.Add($"Error: {ex.Message}", Severity.Error);
            }
        }
    }
}









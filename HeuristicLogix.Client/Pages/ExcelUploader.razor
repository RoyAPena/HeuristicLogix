@page "/excel-uploader"
@using HeuristicLogix.Shared.DTOs
@using HeuristicLogix.Shared.Models
@inject HttpClient HttpClient
@inject ISnackbar Snackbar

<PageTitle>Carga Masiva - HeuristicLogix</PageTitle>

<MudContainer MaxWidth="MaxWidth.Large" Class="mt-4">
    <MudText Typo="Typo.h4" Class="mb-4">
        <MudIcon Icon="@Icons.Material.Filled.UploadFile" Class="mr-2" />
        Carga Masiva de Conduces
    </MudText>

    @* Upload Section *@
    <MudPaper Class="pa-6 mb-4" Elevation="3">
        <MudStack Spacing="4">
            <MudText Typo="Typo.h6">1. Seleccionar Archivo</MudText>
            
            <MudFileUpload T="IBrowserFile" OnFilesChanged="OnFileSelected" MaximumFileCount="1"
                           Accept=".xlsx,.csv">
                <ButtonTemplate>
                    <MudButton HtmlTag="label"
                               Variant="Variant.Filled"
                               Color="Color.Primary"
                               StartIcon="@Icons.Material.Filled.CloudUpload"
                               Size="Size.Large">
                        Seleccionar Excel/CSV
                    </MudButton>
                </ButtonTemplate>
            </MudFileUpload>

            @if (_selectedFile != null)
            {
                <MudAlert Severity="Severity.Info" Icon="@Icons.Material.Filled.InsertDriveFile">
                    @_selectedFile.Name (@FormatFileSize(_selectedFile.Size))
                </MudAlert>
            }

            <MudButton Variant="Variant.Filled" Color="Color.Success" 
                       OnClick="UploadFileAsync" Disabled="@(_selectedFile == null || _uploading)"
                       Size="Size.Large" FullWidth="true">
                @if (_uploading)
                {
                    <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                    <span>Procesando... @_uploadProgress%</span>
                }
                else
                {
                    <MudIcon Icon="@Icons.Material.Filled.Send" Class="mr-2" />
                    <span>Procesar Archivo</span>
                }
            </MudButton>

            <MudDivider />

            <MudButton Variant="Variant.Outlined" 
                       Href="api/logistics/excel/template" 
                       Target="_blank"
                       StartIcon="@Icons.Material.Filled.Download">
                Descargar Plantilla
            </MudButton>
        </MudStack>
    </MudPaper>

    @* Progress Section *@
    @if (_uploading)
    {
        <MudPaper Class="pa-6 mb-4" Elevation="3">
            <MudStack Spacing="3">
                <MudText Typo="Typo.h6">Procesamiento en Curso</MudText>
                <MudProgressLinear Value="@_uploadProgress" Color="Color.Primary" />
                <MudText Typo="Typo.body2" Color="Color.Secondary">
                    @_currentStatus
                </MudText>
            </MudStack>
        </MudPaper>
    }

    @* Results Section *@
    @if (_ingestionResult != null)
    {
        <MudPaper Class="pa-6" Elevation="3">
            <MudText Typo="Typo.h5" Class="mb-4">
                <MudIcon Icon="@Icons.Material.Filled.Assessment" Class="mr-2" />
                Resumen de Ingesta
            </MudText>

            @* Summary Cards *@
            <MudGrid Class="mb-4">
                <MudItem xs="12" sm="6" md="3">
                    <MudCard Elevation="0" Class="border-solid border-2 mud-border-primary">
                        <MudCardContent>
                            <MudText Typo="Typo.h4" Color="Color.Primary">@_ingestionResult.TotalRows</MudText>
                            <MudText Typo="Typo.body2">Total Filas</MudText>
                        </MudCardContent>
                    </MudCard>
                </MudItem>
                <MudItem xs="12" sm="6" md="3">
                    <MudCard Elevation="0" Class="border-solid border-2 mud-border-success">
                        <MudCardContent>
                            <MudText Typo="Typo.h4" Color="Color.Success">@_ingestionResult.SuccessfulRows</MudText>
                            <MudText Typo="Typo.body2">Procesados</MudText>
                        </MudCardContent>
                    </MudCard>
                </MudItem>
                <MudItem xs="12" sm="6" md="3">
                    <MudCard Elevation="0" Class="border-solid border-2 mud-border-error">
                        <MudCardContent>
                            <MudText Typo="Typo.h4" Color="Color.Error">@_ingestionResult.ErrorRows</MudText>
                            <MudText Typo="Typo.body2">Errores</MudText>
                        </MudCardContent>
                    </MudCard>
                </MudItem>
                <MudItem xs="12" sm="6" md="3">
                    <MudCard Elevation="0" Class="border-solid border-2 mud-border-warning">
                        <MudCardContent>
                            <MudText Typo="Typo.h4" Color="Color.Warning">@_ingestionResult.NewProductsIdentified</MudText>
                            <MudText Typo="Typo.body2">Nuevos Productos</MudText>
                        </MudCardContent>
                    </MudCard>
                </MudItem>
            </MudGrid>

            @* Success Rate *@
            <MudAlert Severity="@GetSeverity(_ingestionResult.SuccessRate)" Class="mb-4">
                <strong>Tasa de Éxito:</strong> @_ingestionResult.SuccessRate.ToString("F1")%
                @if (_ingestionResult.ProcessingDuration.HasValue)
                {
                    <span> | Tiempo: @_ingestionResult.ProcessingDuration.Value.TotalSeconds.ToString("F1")s</span>
                }
            </MudAlert>

            @* Errors *@
            @if (_ingestionResult.Errors.Count > 0)
            {
                <MudExpansionPanels MultiExpansion="true">
                    <MudExpansionPanel Text="@($"Errores ({_ingestionResult.Errors.Count})")">
                        <MudStack Spacing="2">
                            @foreach (string error in _ingestionResult.Errors)
                            {
                                <MudAlert Severity="Severity.Error" Dense="true">@error</MudAlert>
                            }
                        </MudStack>
                    </MudExpansionPanel>
                </MudExpansionPanels>
            }

            @* Warnings *@
            @if (_ingestionResult.Warnings.Count > 0)
            {
                <MudExpansionPanels MultiExpansion="true" Class="mt-2">
                    <MudExpansionPanel Text="@($"Advertencias ({_ingestionResult.Warnings.Count})")">
                        <MudStack Spacing="2">
                            @foreach (string warning in _ingestionResult.Warnings)
                            {
                                <MudAlert Severity="Severity.Warning" Dense="true">@warning</MudAlert>
                            }
                        </MudStack>
                    </MudExpansionPanel>
                </MudExpansionPanels>
            }

            @* Actions *@
            <MudStack Row="true" Class="mt-4">
                <MudButton Variant="Variant.Filled" Color="Color.Primary" 
                           Href="/taxonomy">
                    Ver Productos Nuevos
                </MudButton>
                <MudButton Variant="Variant.Outlined" OnClick="ResetUploader">
                    Cargar Otro Archivo
                </MudButton>
            </MudStack>
        </MudPaper>
    }

    @* Help Section *@
    <MudPaper Class="pa-6 mt-4" Elevation="1">
        <MudText Typo="Typo.h6" Class="mb-2">
            <MudIcon Icon="@Icons.Material.Filled.Info" Class="mr-2" />
            Formato del Archivo
        </MudText>
        <MudText Typo="Typo.body2" Class="mb-2">
            El archivo Excel/CSV debe contener las siguientes columnas:
        </MudText>
        <MudList Dense="true" T="string">
            <MudListItem Icon="@Icons.Material.Filled.CheckCircle">
                <strong>ClienteNombre:</strong> Nombre del cliente (requerido)
            </MudListItem>
            <MudListItem Icon="@Icons.Material.Filled.CheckCircle">
                <strong>ProductoDescripcion:</strong> Descripción del producto (requerido)
            </MudListItem>
            <MudListItem Icon="@Icons.Material.Filled.CheckCircle">
                <strong>Cantidad:</strong> Cantidad a entregar (requerido)
            </MudListItem>
            <MudListItem Icon="@Icons.Material.Filled.CheckCircle">
                <strong>UnidadMedida:</strong> Unidad de medida (opcional)
            </MudListItem>
            <MudListItem Icon="@Icons.Material.Filled.CheckCircle">
                <strong>Direccion:</strong> Dirección de entrega (requerido)
            </MudListItem>
            <MudListItem Icon="@Icons.Material.Filled.CheckCircle">
                <strong>CamionPlaca:</strong> Placa del camión (requerido)
            </MudListItem>
        </MudList>
    </MudPaper>
</MudContainer>

@code {
    private IBrowserFile? _selectedFile;
    private bool _uploading = false;
    private int _uploadProgress = 0;
    private string _currentStatus = string.Empty;
    private IngestionSummaryDto? _ingestionResult;

    private void OnFileSelected(InputFileChangeEventArgs e)
    {
        _selectedFile = e.File;
        _ingestionResult = null;
        StateHasChanged();
    }

    private async Task UploadFileAsync()
    {
        if (_selectedFile == null) return;

        _uploading = true;
        _uploadProgress = 0;
        _currentStatus = "Subiendo archivo...";
        StateHasChanged();

        try
        {
            // Create multipart form content
            using MultipartFormDataContent content = new MultipartFormDataContent();
            
            // Read file stream
            Stream fileStream = _selectedFile.OpenReadStream(maxAllowedSize: 20 * 1024 * 1024); // 20MB
            StreamContent streamContent = new StreamContent(fileStream);
            streamContent.Headers.ContentType = new System.Net.Http.Headers.MediaTypeHeaderValue("application/octet-stream");
            
            content.Add(streamContent, "file", _selectedFile.Name);

            _uploadProgress = 30;
            _currentStatus = "Procesando filas...";
            StateHasChanged();

            // Post to API
            HttpResponseMessage response = await HttpClient.PostAsync("api/logistics/excel/upload", content);

            _uploadProgress = 80;
            _currentStatus = "Finalizando...";
            StateHasChanged();

            if (response.IsSuccessStatusCode)
            {
                ProcessingReport? report = await response.Content.ReadFromJsonAsync<ProcessingReport>();
                
                if (report != null)
                {
                    _ingestionResult = new IngestionSummaryDto
                    {
                        ReportId = report.ReportId,
                        FileName = report.FileName,
                        TotalRows = report.TotalRows,
                        SuccessfulRows = report.SuccessfulRows,
                        ErrorRows = report.ErrorRows,
                        NewProductsIdentified = report.NewTaxonomiesCreated,
                        ProcessingDuration = report.ProcessingDuration,
                        SuccessRate = report.SuccessRate,
                        IsSuccess = report.IsSuccess,
                        Errors = report.Errors.Select(e => $"Fila {e.RowNumber}: {e.Message}").ToList(),
                        Warnings = report.Warnings.Select(w => $"Fila {w.RowNumber}: {w.Message}").ToList()
                    };

                    _uploadProgress = 100;
                    _currentStatus = "Completado!";
                    
                    Snackbar.Add($"Archivo procesado: {report.SuccessfulRows}/{report.TotalRows} filas", 
                        report.IsSuccess ? Severity.Success : Severity.Warning);
                }
            }
            else
            {
                string errorContent = await response.Content.ReadAsStringAsync();
                Snackbar.Add($"Error al procesar archivo: {response.StatusCode}", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error: {ex.Message}", Severity.Error);
        }
        finally
        {
            _uploading = false;
            StateHasChanged();
        }
    }

    private void ResetUploader()
    {
        _selectedFile = null;
        _ingestionResult = null;
        _uploadProgress = 0;
        _currentStatus = string.Empty;
        StateHasChanged();
    }

    private string FormatFileSize(long bytes)
    {
        string[] suffixes = { "B", "KB", "MB", "GB" };
        int counter = 0;
        decimal number = bytes;
        while (Math.Round(number / 1024) >= 1)
        {
            number /= 1024;
            counter++;
        }
        return $"{number:F2} {suffixes[counter]}";
    }

    private Severity GetSeverity(decimal successRate)
    {
        if (successRate >= 90) return Severity.Success;
        if (successRate >= 70) return Severity.Warning;
        return Severity.Error;
    }
}

# Hybrid ID Architecture - Quick Reference

## ?? ID Type Cheat Sheet

### Quick Lookup: "What ID type does this entity use?"

| Entity | ID Type | PK Name | Schema | Use Case |
|--------|---------|---------|--------|----------|
| **Category** | `int` | `CategoryId` | Inventory | Master data |
| **Brand** | `int` | `BrandId` | Inventory | Master data |
| **UnitOfMeasure** | `int` | `UnitOfMeasureId` | Core | Master data |
| **Item** | `int` | `ItemId` | Inventory | **Main entity** |
| **TaxConfiguration** | `Guid` | `TaxConfigurationId` | Core | Config data |
| **Supplier** | `Guid` | `SupplierId` | Purchasing | Transactional |
| **ItemUnitConversion** | `Guid` | `ItemUnitConversionId` | Inventory | Bridge entity |
| **ItemSupplier** | Composite | `(ItemId, SupplierId)` | Purchasing | Junction table |
| **StagingPurchaseInvoice** | `Guid` | `StagingPurchaseInvoiceId` | Purchasing | Staging |
| **StagingPurchaseInvoiceDetail** | `Guid` | `StagingPurchaseInvoiceDetailId` | Purchasing | Staging |

## ?? Foreign Key Reference Matrix

### Item (Central Hub) - The Most Important Entity

```csharp
Item.ItemId                        ? int (PK)
Item.BrandId                       ? int (nullable FK to Brand)
Item.CategoryId                    ? int (required FK to Category)
Item.TaxConfigurationId            ? Guid (required FK to TaxConfiguration) ?? Mixed!
Item.BaseUnitOfMeasureId           ? int (required FK to UnitOfMeasure)
Item.DefaultSalesUnitOfMeasureId   ? int (nullable FK to UnitOfMeasure)
```

**Key Insight:** Item uses `int` for all inventory FKs but `Guid` for `TaxConfigurationId`.

### Bridge/Junction Entities

#### ItemUnitConversion (Guid PK, int FKs)
```csharp
ItemUnitConversion.ItemUnitConversionId  ? Guid (PK)
ItemUnitConversion.ItemId                ? int (FK to Item)
ItemUnitConversion.FromUnitOfMeasureId   ? int (FK to UnitOfMeasure)
ItemUnitConversion.ToUnitOfMeasureId     ? int (FK to UnitOfMeasure)
```

#### ItemSupplier (Composite PK: int + Guid)
```csharp
ItemSupplier.ItemId      ? int (PK/FK to Item)
ItemSupplier.SupplierId  ? Guid (PK/FK to Supplier)
```

#### StagingPurchaseInvoiceDetail (Guid PK, mixed FKs)
```csharp
StagingPurchaseInvoiceDetail.StagingPurchaseInvoiceDetailId ? Guid (PK)
StagingPurchaseInvoiceDetail.StagingPurchaseInvoiceId       ? Guid (FK to StagingPurchaseInvoice)
StagingPurchaseInvoiceDetail.ItemId                         ? int (FK to Item)
```

## ?? Decision Rules

### When to use `int` ID?
? Inventory master data (Category, Brand, Item, UnitOfMeasure)  
? When legacy system integration required  
? High-frequency joins expected  
? Sequential IDs acceptable  

### When to use `Guid` ID?
? Transactional entities (Supplier, Invoices, Staging)  
? Configuration/Core entities (TaxConfiguration)  
? Distributed system scenarios  
? Microservice boundaries  
? Bridge/junction tables with Guid PK but int FKs  

### When to use Composite PK?
? Junction tables (ItemSupplier)  
? When natural key is (int, Guid)  
? No surrogate key needed  

## ?? Code Templates

### Creating Entities

#### Inventory Entity (int ID)
```csharp
var item = new Item(
    itemId: 0,                    // 0 = auto-generated by DB
    stockKeepingUnitCode: "SKU",
    itemDescription: "...",
    categoryId: 10,               // int FK
    taxConfigurationId: taxGuid,  // Guid FK ??
    baseUnitOfMeasureId: 5,       // int FK
    costPricePerBaseUnit: 100m,
    sellingPricePerBaseUnit: 150m,
    minimumRequiredStockQuantity: 10m,
    currentStockQuantity: 100m
);
```

#### Transactional Entity (Guid ID)
```csharp
var supplier = new Supplier(
    supplierId: Guid.NewGuid(),  // Client-generated
    nationalTaxIdentificationNumber: "123456789",
    supplierBusinessName: "Acme Corp",
    supplierTradeName: "Acme",
    defaultCreditDaysDuration: 30,
    isActive: true
);
```

#### Bridge Entity (Guid PK, int FKs)
```csharp
var conversion = new ItemUnitConversion(
    itemUnitConversionId: Guid.NewGuid(),  // Guid PK
    itemId: 123,                           // int FK
    fromUnitOfMeasureId: 5,                // int FK
    toUnitOfMeasureId: 8,                  // int FK
    conversionFactorQuantity: 40.00m
);
```

#### Junction Entity (Composite int+Guid)
```csharp
var itemSupplier = new ItemSupplier(
    itemId: 123,              // int PK/FK
    supplierId: supplierGuid, // Guid PK/FK
    supplierInternalPartNumber: "SUP-ABC",
    lastPurchasePriceAmount: 100m,
    lastPurchaseDateTime: DateTimeOffset.UtcNow,
    isPreferredSupplierForItem: true
);
```

### Querying

#### Simple int FK join
```csharp
var items = await context.Items
    .Where(i => i.CategoryId == 10)  // int comparison
    .Include(i => i.Category)        // int join
    .ToListAsync();
```

#### Mixed FK join (int + Guid)
```csharp
var items = await context.Items
    .Where(i => i.CategoryId == 10 && i.TaxConfigurationId == taxGuid)
    .Include(i => i.Category)         // int join
    .Include(i => i.TaxConfiguration) // Guid join ??
    .ToListAsync();
```

#### Composite key query
```csharp
var itemSupplier = await context.ItemSuppliers
    .FirstOrDefaultAsync(s => 
        s.ItemId == 123 &&           // int
        s.SupplierId == supplierGuid // Guid
    );
```

## ?? Common Pitfalls

### ? Wrong: Using Guid for ItemId
```csharp
// DON'T DO THIS
var item = new Item(
    itemId: Guid.NewGuid(), // ? Wrong! Should be int
    ...
);
```

### ? Right: Using int for ItemId
```csharp
var item = new Item(
    itemId: 0, // ? Correct! Auto-generated int
    ...
);
```

### ? Wrong: Using int for SupplierId
```csharp
// DON'T DO THIS
var supplier = new Supplier(
    supplierId: 0, // ? Wrong! Should be Guid
    ...
);
```

### ? Right: Using Guid for SupplierId
```csharp
var supplier = new Supplier(
    supplierId: Guid.NewGuid(), // ? Correct!
    ...
);
```

### ? Wrong: Forgetting Guid FK in Item
```csharp
// DON'T DO THIS
var item = new Item(
    ...
    taxConfigurationId: 18, // ? Wrong! Should be Guid
    ...
);
```

### ? Right: Using Guid for TaxConfigurationId
```csharp
var item = new Item(
    ...
    taxConfigurationId: taxGuid, // ? Correct!
    ...
);
```

## ??? Database Identity Configuration

### int IDs (Auto-increment)
SQL Server automatically configures as `IDENTITY(1,1)`:
```sql
CREATE TABLE [Inventory].[Items]
(
    ItemId int IDENTITY(1,1) NOT NULL PRIMARY KEY,
    ...
);
```

EF Core configuration:
```csharp
entity.HasKey(e => e.ItemId);
// No ValueGeneratedOnAdd needed - it's automatic for int PKs
```

### Guid IDs (Application-generated)
```csharp
entity.HasKey(e => e.SupplierId);
entity.Property(e => e.SupplierId).ValueGeneratedNever();
// Application generates Guid before insert
```

Or SQL Server-generated:
```csharp
entity.Property(e => e.SupplierId)
    .HasDefaultValueSql("NEWSEQUENTIALID()");
```

## ?? Performance Quick Tips

### Indexing
```csharp
// int indexes are smaller and faster
entity.HasIndex(e => e.CategoryId); // 4 bytes per entry

// Guid indexes are larger but still efficient
entity.HasIndex(e => e.TaxConfigurationId); // 16 bytes per entry

// Composite indexes with mixed types
entity.HasIndex(e => new { e.ItemId, e.SupplierId }); // 20 bytes per entry
```

### Joins
- **int joins**: Fastest (sequential, clustered)
- **Guid joins**: Slightly slower but still efficient with proper indexing
- **Mixed joins**: No significant penalty if both columns are indexed

## ?? Troubleshooting

### Error: "Cannot convert Guid to int"
**Problem:** Trying to assign Guid to int FK or vice versa  
**Solution:** Check the ID type matrix above - ensure correct type for each FK

### Error: "Composite key constraint violation"
**Problem:** Trying to insert ItemSupplier with existing (ItemId, SupplierId) pair  
**Solution:** Both components of composite key must be unique together

### Error: "Identity insert is OFF"
**Problem:** Trying to manually set int ID value  
**Solution:** Use `0` for new entities - let DB generate the ID

### Performance Issue: Slow joins
**Problem:** Missing indexes on FK columns  
**Solution:** Verify all FK columns have indexes in AppDbContext

## ?? Related Documentation

- Full Architecture: `ERP_HYBRID_ID_ARCHITECTURE.md`
- Clean Schema: `ERP_CLEAN_SCHEMA_FINAL.md`
- Database Setup: `ERP_DATABASE_SETUP_GUIDE.md`
- ERD Diagrams: `ERP_PERSISTENCE_ERD.md`

---
**Quick Reference v1.0**  
**Last Updated:** January 2025  
**For:** HeuristicLogix ERP - .NET 10 / C# 14

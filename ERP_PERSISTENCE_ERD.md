# ERP Persistence Layer - Entity Relationship Diagram

## Schema Overview

```
???????????????????????????????????????????????????????????????????????????????????
?                           HeuristicLogix ERP Database                            ?
???????????????????????????????????????????????????????????????????????????????????

?????????????????     ???????????????????     ??????????????????????
?  CORE Schema  ?     ? INVENTORY Schema?     ? PURCHASING Schema  ?
?????????????????     ???????????????????     ??????????????????????
?               ?     ?                 ?     ?                    ?
? • TaxConfig   ?? ? ?? • Category      ?? ? ?? • Supplier         ?
? • UnitOfMsr   ?     ? • Brand         ?     ? • ItemSupplier     ?
?               ?     ? • Item ?       ?     ? • PurchaseInvoice  ?
?               ?     ? • ItemUnitConv  ?     ? • Staging...       ?
?????????????????     ???????????????????     ??????????????????????
```

## Core Schema Entities

```
????????????????????????????????????
?      TaxConfiguration           ?
????????????????????????????????????
? PK: TaxConfigurationId (Guid)   ?
????????????????????????????????????
? • TaxName (string)               ?
? • TaxPercentageRate (decimal)   ? ? DECIMAL(5,2)
? • IsActive (bool)                ?
? • CreatedAt (DateTimeOffset)    ?
? • CreatedByUserId (string?)     ?
????????????????????????????????????
         ?
         ? Referenced by PurchaseInvoice.TaxConfigurationId
         ?

????????????????????????????????????
?      UnitOfMeasure              ?
????????????????????????????????????
? PK: UnitOfMeasureId (Guid)      ?
????????????????????????????????????
? • UnitCode (string) ?? UNIQUE   ? ? e.g., "kg", "m", "un"
? • UnitName (string)              ? ? e.g., "Kilogram", "Meter"
? • Description (string?)          ?
? • IsActive (bool)                ?
? • CreatedAt (DateTimeOffset)    ?
????????????????????????????????????
         ?                    ?
         ?                    ?
         ?                    ????????????????????????????
         ?                                               ?
    Referenced by:                              Referenced by:
    • Item.BaseUnitOfMeasureId        • ItemUnitConversion.TransactionalUnitOfMeasureId
```

## Inventory Schema Entities

```
????????????????????????????????????         ????????????????????????????????????
?         Category                ?         ?           Brand                 ?
????????????????????????????????????         ????????????????????????????????????
? PK: CategoryId (Guid)           ?         ? PK: BrandId (Guid)              ?
????????????????????????????????????         ????????????????????????????????????
? • CategoryName (string)          ?         ? • BrandName (string)             ?
? • CategoryDescription (string?)  ?         ? • BrandDescription (string?)     ?
? • ParentCategoryId (Guid?) ???   ?         ? • WebsiteUrl (string?)           ?
? • IsActive (bool)            ?   ?         ? • CountryOfOrigin (string?)      ?
? • CreatedAt (DateTimeOffset) ?   ?         ? • IsActive (bool)                ?
? • CreatedByUserId (string?)  ?   ?         ? • CreatedAt (DateTimeOffset)    ?
????????????????????????????????????         ? • CreatedByUserId (string?)     ?
                               ?             ????????????????????????????????????
                               ?                       ?
                               ?? Self-reference      ?
                                  (Hierarchical)      ?
         ?                                            ?
         ?                                            ?
         ? Referenced by Item.CategoryId     Referenced by Item.BrandId
         ?                                            ?
?????????????????????????????????????????????????????????????????????????????????
?                                  Item ?                                       ?
????????????????????????????????????????????????????????????????????????????????
? PK: ItemId (Guid)                                                            ?
????????????????????????????????????????????????????????????????????????????????
? • StockKeepingUnit (string) ?? UNIQUE    ? Business key (SKU)               ?
? • ItemDescription (string)                                                   ?
? • BaseUnitOfMeasureId (Guid) ????????????? UnitOfMeasure (FK)               ?
? • CategoryId (Guid?)                                                         ?
? • BrandId (Guid?)                                                            ?
? • CurrentStockQuantity (decimal)          ? DECIMAL(18,2) READ-ONLY for UI  ?
? • CostPricePerBaseUnit (decimal)          ? DECIMAL(18,4) WAC               ?
? • SellingPricePerBaseUnit (decimal?)      ? DECIMAL(18,4)                   ?
? • MinimumStockLevel (decimal?)            ? DECIMAL(18,2)                   ?
? • MaximumStockLevel (decimal?)            ? DECIMAL(18,2)                   ?
? • Barcode (string?)                                                          ?
? • IsActive (bool)                                                            ?
? • CreatedAt / LastModifiedAt (DateTimeOffset)                               ?
? • CreatedByUserId / LastModifiedByUserId (string?)                          ?
????????????????????????????????????????????????????????????????????????????????
         ?                                            ?
         ? Referenced by:                             ?
         ? • ItemUnitConversion.ItemId                ?
         ? • ItemSupplier.ItemId                      ?
         ? • PurchaseInvoiceDetail.ItemId             ?
         ? • StagingPurchaseInvoiceDetail.ItemId      ?
         ?                                            ?
         ?                                            ?
?????????????????????????????????????????????         ?
?      ItemUnitConversion                  ?         ?
????????????????????????????????????????????         ?
? PK: ItemUnitConversionId (Guid)         ?         ?
????????????????????????????????????????????         ?
? • ItemId (Guid) ????????????????????????????????????
? • TransactionalUnitOfMeasureId (Guid) ??? UnitOfMeasure (FK)
? • ConversionFactorQuantity (decimal)     ? ? DECIMAL(18,4)
?   Formula: BaseQty = TransQty × Factor   ?
? • IsActive (bool)                        ?
? • CreatedAt (DateTimeOffset)            ?
? • CreatedByUserId (string?)             ?
????????????????????????????????????????????

Example:
  Item: "Rebar Steel"
  Base Unit: "Pala" (shovel unit)
  Transactional Unit: "Metro" (linear meter)
  ConversionFactorQuantity: 40.00
  ? 1 Metro = 40 Palas
```

## Purchasing Schema Entities

```
????????????????????????????????????????????????????????????????????????????????
?                              Supplier                                        ?
????????????????????????????????????????????????????????????????????????????????
? PK: SupplierId (Guid)                                                        ?
????????????????????????????????????????????????????????????????????????????????
? • SupplierName (string)                                                      ?
? • NationalTaxIdentificationNumber (string) ?? UNIQUE  ? RNC (9 or 11 digits)?
? • ContactPersonName (string?)                                                ?
? • ContactEmailAddress (string?)                                              ?
? • ContactPhoneNumber (string?)                                               ?
? • PhysicalAddress (string?)                                                  ?
? • DefaultCreditDaysDuration (int?)         ? Template credit terms          ?
? • IsActive (bool)                                                            ?
? • CreatedAt / LastModifiedAt (DateTimeOffset)                               ?
? • CreatedByUserId / LastModifiedByUserId (string?)                          ?
????????????????????????????????????????????????????????????????????????????????
         ?                                            ?
         ? Referenced by:                             ?
         ? • ItemSupplier.SupplierId                  ?
         ? • PurchaseInvoice.SupplierId               ?
         ? • StagingPurchaseInvoice.SupplierId        ?
         ?                                            ?
         ?                                            ?
?????????????????????????????????????????????         ?
?         ItemSupplier                     ?         ?
????????????????????????????????????????????         ?
? PK: ItemSupplierId (Guid)               ?         ?
????????????????????????????????????????????         ?
? • ItemId (Guid) ???????????? Item (FK)   ?         ?
? • SupplierId (Guid) ????????????????????????????????
? • SupplierProductCode (string?)          ? ? Supplier's SKU
? • LastPurchasePricePerBaseUnit (dec?)   ? ? DECIMAL(18,4) Auto-updated
? • LastPurchaseDate (DateTimeOffset?)    ? ? Auto-updated on approval
? • LeadTimeDays (int?)                    ?
? • MinimumOrderQuantity (decimal?)        ? ? DECIMAL(18,2)
? • IsActive (bool)                        ?
? • CreatedAt / LastModifiedAt             ?
? • CreatedByUserId / LastModifiedByUserId ?
????????????????????????????????????????????

Purpose: Maintains supplier catalog with pricing history
Updated by: Domain service during Purchase Invoice approval
```

### Purchase Invoice Flow (Staging ? Approved)

```
???????????????????????????????????????????????????????????????????????????????
?                         PHASE A: INGESTION (Staging)                        ?
???????????????????????????????????????????????????????????????????????????????

????????????????????????????????????????????????????????????????????????????????
?                    StagingPurchaseInvoice                                    ?
????????????????????????????????????????????????????????????????????????????????
? PK: StagingPurchaseInvoiceId (Guid)                                         ?
????????????????????????????????????????????????????????????????????????????????
? • SupplierIdentifier (string)               ? Raw import (name or tax ID)   ?
? • SupplierId (Guid?)                        ? Resolved after validation     ?
? • FiscalReceiptNumber (string)              ? NCF: B0100000123              ?
? • InvoiceIssueDateTime (DateTimeOffset)                                     ?
? • CreditDaysDuration (int?)                                                 ?
? • SubtotalAmount / TaxAmount / TotalAmount  ? All DECIMAL(18,4)            ?
? • ValidationStatus (enum ? string) ???????  ? Pending|Validated|Approved    ?
?   - Pending                              ?                                  ?
?   - Validated ????? After validation     ?                                  ?
?   - Invalid                              ?                                  ?
?   - Approved ????? After atomic commit   ?                                  ?
?   - Rejected                             ?                                  ?
? • ValidationErrorMessages (string?)      ?                                  ?
? • ImportBatchId (string?)                ?                                  ?
? • CreatedAt / ProcessedAt                ?                                  ?
? • CreatedByUserId / ProcessedByUserId    ?                                  ?
???????????????????????????????????????????????????????????????????????????????
         ? 1:Many                          ?
         ?                                 ?
         ?                                 ?
???????????????????????????????????????????????????????????????????????????????
?               StagingPurchaseInvoiceDetail                                  ?
????????????????????????????????????????????????????????????????????????????????
? PK: StagingPurchaseInvoiceDetailId (Guid)                                  ?
????????????????????????????????????????????????????????????????????????????????
? • StagingPurchaseInvoiceId (Guid) ????????? StagingPurchaseInvoice (FK)    ?
? • ItemIdentifier (string)                   ? Raw import (SKU or desc)      ?
? • ItemId (Guid?)                            ? Resolved after validation     ?
? • LineNumber (int)                                                          ?
? • QuantityImported (decimal)                ? DECIMAL(18,2) As-imported     ?
? • UnitOfMeasureIdentifier (string)          ? Raw import ("kg", "Metro")    ?
? • UnitOfMeasureId (Guid?)                   ? Resolved after validation     ?
? • QuantityInBaseUnit (decimal?)             ? DECIMAL(18,2) Calculated      ?
? • UnitPriceImported (decimal)               ? DECIMAL(18,4) As-imported     ?
? • UnitPricePerBaseUnit (decimal?)           ? DECIMAL(18,4) Calculated      ?
? • LineSubtotalAmount / LineTaxAmount        ? All DECIMAL(18,4)            ?
? • LineTotalAmount                                                           ?
? • ValidationErrorMessages (string?)                                         ?
? • CreatedAt (DateTimeOffset)                                               ?
????????????????????????????????????????????????????????????????????????????????

                              ?
                              ? ATOMIC TRANSACTION (Phase B: Approval)
                              ? Domain Service performs:
                              ? 1. Move data to PurchaseInvoice
                              ? 2. Update Item.CurrentStockQuantity
                              ? 3. Recalculate Item.CostPricePerBaseUnit (WAC)
                              ? 4. Update ItemSupplier pricing
                              ? 5. Mark staging as Approved
                              ?

???????????????????????????????????????????????????????????????????????????????
?                      PHASE B: APPROVED (Live Tables)                        ?
???????????????????????????????????????????????????????????????????????????????

????????????????????????????????????????????????????????????????????????????????
?                         PurchaseInvoice                                      ?
????????????????????????????????????????????????????????????????????????????????
? PK: PurchaseInvoiceId (Guid)                                                ?
????????????????????????????????????????????????????????????????????????????????
? • SupplierId (Guid) ??????????????????????? Supplier (FK)                   ?
? • FiscalReceiptNumber (string)              ? NCF: B0100000123              ?
? • InvoiceIssueDateTime (DateTimeOffset)                                     ?
? • CreditDaysDuration (int?)                                                 ?
? • InvoiceDueDate (DateTimeOffset?)          ? IssueDate + CreditDays        ?
? • SubtotalAmount / TaxAmount / TotalAmount  ? All DECIMAL(18,4)            ?
? • TaxConfigurationId (Guid?)                ? TaxConfiguration (FK)         ?
? • ApprovedAt (DateTimeOffset)               ? Approval timestamp            ?
? • ApprovedByUserId (string)                 ? Approval user                 ?
? • CreatedAt (DateTimeOffset)                                               ?
????????????????????????????????????????????????????????????????????????????????
         ? 1:Many
         ?
         ?
????????????????????????????????????????????????????????????????????????????????
?                    PurchaseInvoiceDetail                                     ?
????????????????????????????????????????????????????????????????????????????????
? PK: PurchaseInvoiceDetailId (Guid)                                         ?
????????????????????????????????????????????????????????????????????????????????
? • PurchaseInvoiceId (Guid) ????????????????? PurchaseInvoice (FK)          ?
? • ItemId (Guid) ????????????????????????????? Item (FK)                     ?
? • LineNumber (int)                                                          ?
? • QuantityInBaseUnit (decimal)              ? DECIMAL(18,2)                ?
? • UnitPricePerBaseUnit (decimal)            ? DECIMAL(18,4)                ?
? • LineSubtotalAmount / LineTaxAmount        ? All DECIMAL(18,4)            ?
? • LineTotalAmount                                                           ?
? • CreatedAt (DateTimeOffset)                                               ?
????????????????????????????????????????????????????????????????????????????????
         ?
         ? Upon creation, triggers updates to:
         ?
         ???? Item.CurrentStockQuantity        (Add QuantityInBaseUnit)
         ???? Item.CostPricePerBaseUnit        (Recalculate WAC)
         ???? ItemSupplier.LastPurchasePrice   (Update pricing)
              ItemSupplier.LastPurchaseDate
```

## Key Relationships Summary

### Foreign Keys
```
Category
  ? Category.ParentCategoryId (Self-reference)

UnitOfMeasure
  ? Item.BaseUnitOfMeasureId
  ? ItemUnitConversion.TransactionalUnitOfMeasureId

Brand
  ? Item.BrandId

Category
  ? Item.CategoryId

Item
  ? ItemUnitConversion.ItemId
  ? ItemSupplier.ItemId
  ? PurchaseInvoiceDetail.ItemId
  ? StagingPurchaseInvoiceDetail.ItemId (nullable)

Supplier
  ? ItemSupplier.SupplierId
  ? PurchaseInvoice.SupplierId
  ? StagingPurchaseInvoice.SupplierId (nullable)

TaxConfiguration
  ? PurchaseInvoice.TaxConfigurationId

PurchaseInvoice
  ? PurchaseInvoiceDetail.PurchaseInvoiceId

StagingPurchaseInvoice
  ? StagingPurchaseInvoiceDetail.StagingPurchaseInvoiceId
```

## Data Flow: Purchase Invoice Import

```
????????????????
? Excel/CSV    ?
? File Upload  ?
????????????????
       ?
       ?
????????????????????????????????????????????
?  1. IMPORT                               ?
?  Create StagingPurchaseInvoice           ?
?  + StagingPurchaseInvoiceDetail          ?
?  ValidationStatus = Pending              ?
????????????????????????????????????????????
       ?
       ?
????????????????????????????????????????????
?  2. VALIDATE                             ?
?  Resolve:                                ?
?  • Supplier (by name or tax ID)          ?
?  • Items (by SKU or description)         ?
?  • Units (by code)                       ?
?  Calculate:                              ?
?  • QuantityInBaseUnit (unit conversion)  ?
?  • UnitPricePerBaseUnit (price conv)     ?
?  • Line totals                           ?
?  Update ValidationStatus:                ?
?  ? Validated (success)                   ?
?  ? Invalid (failure)                     ?
????????????????????????????????????????????
       ?
       ?
????????????????????????????????????????????
?  3. USER REVIEW                          ?
?  UI displays staging data with:          ?
?  • Validation errors (if any)            ?
?  • Calculated values                     ?
?  User decision:                          ?
?  ? Approve (if Validated)                ?
?  ? Reject (if Invalid or unwanted)       ?
????????????????????????????????????????????
       ?
       ?
????????????????????????????????????????????
?  4. ATOMIC APPROVAL TRANSACTION          ?
?  BEGIN TRANSACTION                       ?
?  ?? Create PurchaseInvoice               ?
?  ?? Create PurchaseInvoiceDetails        ?
?  ?? FOR EACH Detail:                     ?
?  ?  ?? Item.CurrentStockQuantity += Qty  ?
?  ?  ?? Recalculate Item.CostPrice (WAC)  ?
?  ?  ?? Update ItemSupplier pricing       ?
?  ?? Mark staging as Approved             ?
?  ?? COMMIT                               ?
????????????????????????????????????????????
       ?
       ?
????????????????
? Inventory    ?
? Updated ?    ?
????????????????
```

## Legends

```
Symbol Key:
  PK: = Primary Key
  FK  = Foreign Key
  ??  = Unique Constraint
  ?  = Core Entity
  ?   = Nullable
  ?   = Direction of reference
  ?   = Process boundary
  ?   = Data flow direction
```

---
**Diagram Version**: 1.0  
**Last Updated**: January 2025  
**For**: HeuristicLogix ERP - .NET 10 / C# 14

# HeuristicLogix UI - Multi-Stage Dockerfile
# Blazor WebAssembly with ASP.NET Core Host

# ============================================================================
# Stage 1: Build Environment
# ============================================================================
FROM mcr.microsoft.com/dotnet/sdk:10.0 AS build
WORKDIR /src

# Copy solution and project files
COPY ["HeuristicLogix.sln", "./"]
COPY ["HeuristicLogix.Client/HeuristicLogix.Client.csproj", "HeuristicLogix.Client/"]
COPY ["HeuristicLogix.Shared/HeuristicLogix.Shared.csproj", "HeuristicLogix.Shared/"]

# Restore dependencies
RUN dotnet restore "HeuristicLogix.Client/HeuristicLogix.Client.csproj"

# Copy all source files
COPY . .

# Build project
WORKDIR "/src/HeuristicLogix.Client"
ARG BUILDCONFIG=Release
RUN dotnet build "HeuristicLogix.Client.csproj" \
    -c $BUILDCONFIG \
    -o /app/build \
    --no-restore

# ============================================================================
# Stage 2: Publish
# ============================================================================
FROM build AS publish
ARG BUILDCONFIG=Release
RUN dotnet publish "HeuristicLogix.Client.csproj" \
    -c $BUILDCONFIG \
    -o /app/publish \
    --no-build \
    --no-restore \
    /p:UseAppHost=false

# ============================================================================
# Stage 3: Runtime Environment (Nginx for WASM hosting)
# ============================================================================
FROM nginx:alpine AS runtime
WORKDIR /usr/share/nginx/html

# Remove default nginx website
RUN rm -rf /usr/share/nginx/html/*

# Copy published Blazor WASM application
COPY --from=publish /app/publish/wwwroot .

# Copy custom nginx configuration
COPY <<EOF /etc/nginx/conf.d/default.conf
server {
    listen 5001;
    server_name _;
    
    location / {
        root /usr/share/nginx/html;
        try_files \$uri \$uri/ /index.html =404;
        
        # Enable WASM MIME type
        types {
            application/wasm wasm;
        }
        
        # Enable compression
        gzip on;
        gzip_types application/wasm application/javascript text/css;
        
        # Security headers
        add_header X-Frame-Options "SAMEORIGIN" always;
        add_header X-Content-Type-Options "nosniff" always;
        add_header X-XSS-Protection "1; mode=block" always;
    }
    
    # Health check endpoint
    location /health {
        access_log off;
        return 200 "healthy\n";
        add_header Content-Type text/plain;
    }
}
EOF

# Expose UI port
EXPOSE 5001

# Health check
HEALTHCHECK --interval=30s --timeout=5s --start-period=10s --retries=3 \
    CMD wget --quiet --tries=1 --spider http://localhost:5001/health || exit 1

# Start nginx
CMD ["nginx", "-g", "daemon off;"]
